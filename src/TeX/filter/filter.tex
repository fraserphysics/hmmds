% Examples of filtering and smoothing

% Copyright 2022, 2024 Andrew M. Fraser.
\documentclass[12pt]{article}
\usepackage{graphicx,color}
\usepackage{amsmath, amsfonts}
\usepackage{placeins}


\newcommand{\field}[1]{\mathbb{#1}}
\newcommand{\INTEGER}{\field{Z}}
\newcommand{\REAL}{\field{R}}
\newcommand{\COMPLEX}{\field{C}}
\newcommand{\EV}{\field{E}}
\newcommand{\id}{\mathbb{I}}
\newcommand{\variance}[1]{\field{V}\left[ #1 \right]}
\newcommand{\normal}[2]{{\cal N}\left(#1,#2 \right)}
\newcommand{\diff}{\text{d}}

\newcommand{\filterplot}[2]{
\begin{figure}
  \centering
  \resizebox{0.7\textwidth}{!}{\includegraphics{#1.pdf}}
  \caption{#2}
  \label{fig:#1}
\end{figure}
}

\title{Illustrations of Filtering and Smoothing}
\author{Andrew M.\ Fraser}

\begin{document}
\maketitle

\section{Introduction}
\label{sec:introduction}

I have written code for the following tasks:
\begin{itemize}
\item Kalman filtering and smoothing
\item Extended Kalman filtering
\item Particle filtering
\item Simulate stochastic differential equations to exercise the
  filtering code
\end{itemize}
This document started as a collection of figures that illustrate data
generated by that code.  Build this document from the root directory
for hmmds by issuing:
\begin{verbatim}
$ make -f alt\_makefile build/Tex/filter/filter.pdf
\end{verbatim}

\section{Build System}

The file src/TeX/filter/Rules.mk defines the dependencies for making
this document.  They are primarily pdfs.  Rules for building the pdfs
are in src/plotscripts/filter/Rules.mk.  And rules for making the data
that the figures need are in src/hmmds/synthetic/filter/Rules.mk.

There are pattern rules for making \%\_filter.pdf or \%\_smooth.pdf from
\%\_data in src/plotscripts/filter/Rules.mk.  And
src/hmmds/synthetic/filter/Rules.mk has the rules for making the
\%\_data files.

\section{Linear Map}
\label{sec:linear_map}

I define a linear Gaussian state space system
\begin{subequations}
  \label{eq:linear_map}
  \begin{align}
    \label{eq:linear_state_map}
    x[t+1] &= A x[t] + B V[t] \\
    y[t] &= C x[t] + D W[t] \\
    A &=
        \begin{bmatrix}
          \cos(\omega dt) & \sin(\omega dt)\\
          -\sin(\omega dt) & \cos(\omega dt)
        \end{bmatrix} \cdot e^{-a dt} \\
    B &=
        \begin{bmatrix}
          b\sqrt{dt} & 0 \\ 0 & b\sqrt{dt}
        \end{bmatrix} \\
    C &=
        \begin{bmatrix}
          c & 0
        \end{bmatrix}\\
    D &=
        \begin{bmatrix}
         d
        \end{bmatrix}
  \end{align}
\end{subequations}
where $V$ and $W$ are unit variance iid Gaussian noise.
Figures~\ref{fig:linear_map_filter} and \ref{fig:linear_map_smooth}
illustrate the behavior of the system with the values
\begin{align*}
  \omega &= 2\pi && \text{frequency} = 1\\
  a &= 0.01 && \text{relaxation time is 100 cyles}\\
  b &= 2 && \text{state noise scale} \\
  c &= 0.5 && \text{observation multiplier} \\
  d &= 25 && \text{observation noise scale}.
\end{align*}
Figure~\ref{fig:linear_map_filter} has the following subplots:
\begin{description}
\item[Upper left:] A phase portrait, $x_1$ vs $x_0$
\item[Center left:] Time series, $x_0$ and $x_1$ vs $t$.  The curves
  are sampled 100 times per cycle and dots represent 20 samples per
  cycle.
  % Rules.mk: FILTER_ARGS = --sample_rate 100 --sample_ratio 5
  The data for filtering and smoothing are sampled at that rate.
\item[Lower left:] Simulated data $y_0$ vs $t$ with dots representing
  the samples.
\item[Upper right:] The sampled observations $y_0$ vs $t$
\item[Center right:] The first component of the state, $x_0$, and the
  estimate of the first component from a forward Kalman filter,
  $\hat x_0$, vs $t$.
\item[Lower right:] The difference, $\hat x_0 - x_0$, and twice the
  square root of the estimated variance, $2\sqrt{\Sigma_{0,0}}$,
  vs $t$.
\end{description}
%
\filterplot{linear_map_filter}{Kalman filter applied to data from a
  stationary linear map.  On the left, top to bottom: True phase
  space; True time series (dots at sample rate); Noisy observation
  time series.  On the right top to bottom: Observation time series;
  True and estimated time series; Actual error and estimated
  deviation.  Note that the data for the right hand column is drawn
  independently from the data in the left hand column.}
%
\pagebreak %
And Fig.~\ref{fig:linear_map_smooth} has the following subplots:
\begin{description}
\item[Upper left:] The estimate of the first component from a forward
  Kalman filter, $\hat x_0$, and the first component of the state,
  $x_0$, vs $t$.
\item[Center left:] The estimate of the first component from a backward
  Kalman filter, $\hat x_0$, vs $t$.
\item[Lower left:] The estimate of the first component from smoothing
  that uses both a forward and a backward pass through the data,
  $\hat x_0$, vs $t$.
\item[Upper right:] The error and estimated standard deviation for
  $x_0$ from a forward pass through the data.
\item[Center right:] The error and estimated standard deviation for
  $x_0$ from a backward pass through the data.
\item[Lower right:] The error and estimated standard deviation for
  $x_0$ from combining a forward and a backward pass through the data.
\end{description}

\filterplot{linear_map_smooth}{A smoothing filter applied to the data
  illustrated in the upper right hand plot of Fig.~\ref{fig:linear_map_filter} }%
\pagebreak

The plots in Figs. \ref{fig:linear_sde_filter} and
\ref{fig:linear_sde_smooth} are like the plots in
Figs.~\ref{fig:linear_map_filter} \ref{fig:linear_map_smooth} except
that the data are generated by simulating a stochastic differential
equation (SDE).  In particular Eqn.~\eqref{eq:linear_state_map} is
replaced by integrating
\begin{equation}
  \label{eq:linear_state_sde}
  \diff x = A x \diff t + \diff \Omega
\end{equation}
where $\Omega$ is a Wiener process\footnote{The code in
  hmm.state\_space.SDE simulates the Wiener process by integrating for
  a time step $\tau$ and adding $\sqrt{\tau}\cdot B$ to the result.}.
The result is a linear discrete time system, but it exercises code for
extended Kalman filtering (EKF) that integrates an SDE and the tangent
to the underlying ODE.

\filterplot{linear_sde_filter}{Extended Kalman filter applied to
  linear stochastic differential equation.  Like
  Fig.~\ref{fig:linear_map_filter}, but state maps come from
  integrating tangents.}

\filterplot{linear_sde_smooth}{Extended smoothing applied to
  linear stochastic differential equation.  Like
  Fig.~\ref{fig:linear_map_smooth}, but state maps come from
  integrating tangents.}\pagebreak

The plots in Fig. \ref{fig:linear_particle_filter} are like the plots
in Figs.~\ref{fig:linear_map_filter} except that the estimates come
from a particle filter.
\filterplot{linear_particle_filter}{Particle filter applied to data
  from a linear map.  Like Fig.~\ref{fig:linear_map_filter}.}\pagebreak

The plots in Figs. \ref{fig:lorenz_filter} and
\ref{fig:lorenz_smooth} are like the plots in
Figs.~\ref{fig:linear_sde_filter} \ref{fig:linear_sde_smooth} except
that the underlying ODE is the Lorenz system.

\filterplot{lorenz_filter}{Extended Kalman filter applied to Lorenz
  system with two dimensional observations.}

\filterplot{lorenz_smooth}{Extended smoothing filter applied to Lorenz
  system with two dimensional observations.} \pagebreak

\filterplot{lorenz_particle_filter}{Particle filter applied to Lorenz
  system.  Like Fig.~\ref{fig:lorenz_filter}
  except that estimates are from a particle filter rather than an EKF.}

\filterplot{log_likelihood}{An illustration of maximum likelihood
  estimation.  Samples, $y[0:1000]$, drawn from foo with a noise scale
  $b=0.01$ appear in the upper plot.  The log likelihoods
  $\log\left(p(y[0:1000]|b)\right)$ of systems with a range of
  different values for $b$ appear in the lower plot.}

% Makefile: _python $< --n_samples 10000 --a 0.05 --b 0.2 $@
\filterplot{distribution}{Test a formula for the variance of states
  generated by a linear SDE using 10,000 samples with $a=0.05$ and
  $b=0.2$.  Only 1,000 samples appear in the upper plot.  Below that
  is a \emph{probability plot} which compares the cumulative
  distribution of the actual data to the cumulative distribution of a
  normal distribution with the variance given by the formula
  $\EV(x^2) = \frac{b^2}{1 - e^{-2*a*dt}}$.}

\end{document}
