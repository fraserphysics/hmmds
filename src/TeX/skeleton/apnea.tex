\chapter{Obstructive Sleep Apnea}
\label{chap:apnea}

The challenge for the \emph{Computers in Cardiology} %
\index{Computers in Cardiology 2000 (CINC2000)}%
meeting in 2000 (CINC2000) %
\index{CINC2000 (Computers in Cardiology 2000)}%
was to identify \emph{obstructive sleep apnea} on the basis of
electrocardiograms alone.  My colleague James \index*{McNames} at
Portland State University, with some support from me, won the prize
for the best minute by minute analysis of data.  I prepared our first
entry using HMMs, and McNames prepared the subsequent (and winning)
entries by hand using spectrograms\footnote{A spectrogram is display
  of power in Fourier spectral bands as a function of time.  The
  x-axis is time, the y-axis is frequency, and the image intensity at
  point $(t,f)$ is the power in that frequency estimated in a window
  centered at that time.} to visualize the data.  \index{spectrogram}

In preparing the first entry, I noticed that apnea produced many
different characteristics in heart rate time series while the
characteristics in non-apnea times were more similar to each other.  I
used a larger number of states in HMMs to model the various
characteristics of apnea and a smaller number of states to model the
more consistent normal times.  However using the maximum a posteriori
probability (MAP) estimate sequence of states from the Viterbi
algorithm, ie,
\begin{equation*}
  \hat {\ts{s}{1}{T}} \equiv
  \argmax_{\ts{s}{1}{T}}P\left(\ts{s}{1}{T} | \ts{y}{1}{T} \right)
\end{equation*}
to estimate the sequence of classifications $\hat {\ts{c}{1}{T}}$ with
\begin{equation*}
  \hat {\ti{c}{t}} \equiv c:\hat {\ti{s}{t}} \in c
\end{equation*}
produced obvious errors.  I found that during many periods of apnea
the probability of being in each of the apnea states was lower than
the probability of being in the normal state with the highest
probability while the sum of the probabilities of apnea states was
larger than the sum over normal states.  My effort to model the
diversity of apnea characteristics led to decoded sequences that were
normal too often.

I tried to address the issue by estimating the MAP sequence of classes
rather than the MAP sequence of states, ie,
\begin{equation}
  \label{eq:decode_class}
  \hat {\ts{c}{1}{T}} \equiv
  \argmax_{\ts{c}{1}{T}}P\left(\ts{c}{1}{T} | \ts{y}{1}{T}\right).
\end{equation}
While the computational complexity of Viterbi algorithm which finds
the MAP sequence of states is linear in $T$, the length of the
sequence of observations, the computational complexity required to
solve \eqref{eq:decode_class} is exponential\footnote{In the first
  edition of this book, I presented an algorithm that I claimed solved
  \eqref{eq:decode_class} in linear complexity.  In some cases that
  algorithm yields plausible but not necessarily correct results and
  in others it simply crashes.} in $T$.

In this chapter, I will first describe the CINC2000 challenge and how
McNames addressed it.  Then I will address the challenge using HMMs.

\section{The  Challenge and the Data}
\label{sec:challenge}

The PhysioNet
website\footnote{\url{http://www.physionet.org/challenge/2000}}
announced the challenge and described the data as follows:

{\it % italic to signify quote
  {\rm \textbf{Introduction:}}
  %
  Obstructive sleep apnea (intermittent cessation of breathing) is a
  common problem with major health implications, ranging from
  excessive daytime drowsiness to serious cardiac arrhythmias.
  Obstructive sleep apnea is associated with increased risks of high
  blood pressure, myocardial infarction, and stroke, and with
  increased mortality rates. Standard methods for detecting and
  quantifying sleep apnea are based on respiration monitoring, which
  often disturbs or interferes with sleep and is generally expensive.
  A number of studies during the past 15 years have hinted at the
  possibility of detecting sleep apnea using features of the
  electrocardiogram. Such approaches are minimally intrusive,
  inexpensive, and may be particularly well-suited for screening. The
  major obstacle to use of such methods is that careful quantitative
  comparisons of their accuracy against that of conventional
  techniques for apnea detection have not been published.

  We therefore offer a challenge to the biomedical research community:
  demonstrate the efficacy of ECG-based methods for apnea detection
  using a large, well-characterized, and representative set of data.
  The goal of the contest is to stimulate effort and advance the state
  of the art in this clinically significant problem, and to foster
  both friendly competition and wide-ranging collaborations. We will
  award prizes of US\$500 to the most successful entrant in each of two
  events.

  {\rm \textbf{Data for development and evaluation:}}
  %
  Data for this contest have kindly been provided by Dr. Thomas
  Penzel \index{Penzel, Dr.\ Thomas}  of Philipps-University, Marburg,
  Germany [available on the website].

  The data to be used in the contest are divided into a learning set
  and a test set of equal size. Each set consists of 35 recordings,
  containing a single ECG signal digitized at 100 Hz with 12-bit
  resolution, continuously for approximately 8 hours (individual
  recordings vary in length from slightly less than 7 hours to nearly
  10 hours). Each recording includes a set of reference annotations,
  one for each minute of the recording, that indicate the presence or
  absence of apnea during that minute. These reference annotations
  were made by human experts on the basis of simultaneously recorded
  respiration signals. Note that the reference annotations for the
  test set will not be made available until the conclusion of the
  contest. Eight of the recordings in the learning set include three
  respiration signals (oronasal airflow measured using nasal
  thermistors, and chest and abdominal respiratory effort measured
  using inductive plethysmography) each digitized at 20 Hz, and an
  oxygen saturation signal digitized at 1 Hz. These additional signals
  can be used as reference material to understand how the apnea
  annotations were made, and to study the relationships between the
  respiration and ECG signals. [...]

  {\rm \textbf{Data classes:}}
  %
  For the purposes of this challenge, based on these varied criteria,
  we have defined three classes of recordings:
  \begin{description}
  \item[Class A (Apnea):] These meet all criteria. Recordings in class
    A contain at least one hour with an apnea index of 10 or more, and
    at least 100 minutes with apnea during the recording. The learning
    and test sets each contain 20 class A recordings.
  \item[Class B (Borderline):] These meet some but not all of the
    criteria. Recordings in class B contain at least one hour with an
    apnea index of 5 or more, and between 5 and 99 minutes with apnea
    during the recording. The learning and test sets each contain 5
    class B recordings.
  \item[Class C (Control):] These meet none of the criteria, and may
    be considered normal. Recordings in class C contain fewer than 5
    minutes with apnea during the recording. The learning and test
    sets each contain 10 class C recordings.
  \end{description}

  {\rm \textbf{Events and scoring:}}
  %
  Each entrant may compete in one or both of the following events:
  \begin{description}
  \item[1. Apnea screening:] In this event, your task is to design
    software that can classify the 35 test set recordings into class A
    (apnea) and class C (control or normal) groups, using the ECG
    signal to determine if significant sleep apnea is present.  [...]
  \item[2. Quantitative assessment of apnea:] In this event, your
    software must generate a minute-by-minute annotation file for each
    recording, in the same format as those provided with the learning
    set, using the ECG signal to determine when sleep apnea occurs.
    Your annotations will be compared with a set of reference
    annotations to determine your score. Each annotation that matches
    a reference annotation earns one point; thus the highest possible
    score for this event will be approximately 16800 (480 annotations
    in each of 35 records). It is important to understand that scores
    approaching the maximum are very unlikely, since apnea assessment
    can be very difficult even for human experts. Nevertheless, the
    scores can be expected to provide a reasonable ranking of the
    ability of the respective algorithms to mimic the decisions made
    by human experts.
  \end{description}
}%% end \it for quote


\subsection{The Data}
\label{sec:data}
%%% FixMe: In runs using CM fonts, I see too much space under
%%% FixMe: fig:a03erA.  It and fig:a03erN get put on facing pages.
%%% FixMe: The following text breaks right after "45 seconds and",
%%% FixMe: and there is several inches of empty vertical whitespace
%%% FixMe:  between the figure and the text.

Briefly, one can fetch the following records from PhysioNet:
\begin{description}
\item[a01-a20:] The \emph{a records} from individuals that display
  \emph{apnea}
\item[b01-b05:] The \emph{b records}\footnote{The amplitude of the
    \emph{b05} record varies dramatically over different segments of
    time.  I found it unusable and discarded it entirely.} from
  individuals diagnosed as \emph{borderline}
\item[c01-c10:] The \emph{c records} from \emph{control} or normal
  individuals
\item[a01er-a04er and b01er and c01er:] Identical to \emph{a01-a04}
  and \emph{b01} and \emph{c01} except augmented with respiration and
  $SpO_2$ (percent of arterial hemoglobin saturated with oxygen)
  \nomenclature[rSpO]{$SpO_2$}{Percent of arterial hemoglobin
    saturated with oxygen.} signals
\item[summary\_of\_training:] Expert classifications of each minute in
  the $a$, $b$, and $c$ records
\item[x01-x35:] The test set\footnote{The records \emph{x33} and
    \emph{x34} are so similar that I suspect they are simultaneous
    recordings from different ECG leads.  I did not explicitly exploit
  the similarity in my analysis.}; records without classification
\end{description}

Using data visualization tools\footnote{One can use the script
  hmmds.applications.apnea.explore.py from the software I used to
  create this book to explore aspects of the data.} one can see
striking oscillations in the apnea time series.  The patients stop
breathing for tens of seconds, gasp a few breaths, and stop again.
Each cycle takes about 45 seconds and can go on for most of the night.
I've plotted two periods of such an oscillation from record \emph{a03}
in Fig.~\ref{fig:a03erA}.  The reference or \emph{expert}
classifications provided with the data indicate these are the last
oscillations in the first apnea episode of the night.  Over the entire
night's record of 8 hours and 39 minutes, the patient had apnea for a
total of 4 hours and five minutes in 11 separate episodes.  In that
time, more than once a minute, he was waking up enough to start
breathing.  Ten and a half minutes after the end of the first apnea
episode, the record, as plotted in Fig.~\ref{fig:a03erN}, looks
normal.

\begin{figure}
  \centering{\resizebox{\textwidth}{!}{\includegraphics{a03erA.pdf}}
  }
  \caption[A segment of record a03]%
  {A segment of record a03.  Two cycles of a large apnea
    induced oscillation in $SpO_2$ are drawn in the lower plot.  The
    middle plot is the oronasal airflow signal, and the upper plot is
    the ECG (units of both ONR and ECG are unknown).  The time
    axis is marked in \emph{hours:minutes}.  Notice the increased
    heart rate just after 0:58 and just before 0:59.}
  \label{fig:a03erA}
\end{figure}

\begin{figure}
  \centering{\resizebox{\textwidth}{!}{\includegraphics{a03erN.pdf}}
  }
  \caption[A segment of record a03]%
  {A segment of record a03 taken during a period of normal
    respiration.  Signals the same as in Fig.~6.1.}
  \label{fig:a03erN}
\end{figure}

In plots like Fig.~\ref{fig:a03erA}, the heart rate visibly increases
at the end of the gasping phase and then decreases during the phase of
interrupted respiration.  That heart rate oscillation is the key I
used in my initial attempts to classify periods of apnea.  In
Fig.~\ref{fig:a03erHR}, I've plotted both a heart rate derived from
the ECG \nomenclature[rECG]{ECG}{Electrocardiogram} and the $SpO_2$
signal.  The oscillations in the signals track each other, and the
expert classifies only the region of large heart rate oscillation as
apnea.
\begin{figure}
  \centering{\resizebox{\textwidth}{!}{\includegraphics{a03HR.pdf}}
  }
  \caption[A segment of record 03 at the end of an episode of apnea]%
  {A segment of record 03 at the end of an episode of apnea with
    indications in both the $SpO_2$ signal and the heart rate
    \emph{(HR)} signal.  The expert marked the time before 1:00 as
    apnea and the time afterwards as normal.}
  \label{fig:a03erHR}
\end{figure}

\section{Using Information from Experts to Train}

I first considered the CINC2000 challenge when Andreas
Rechtsteiner told me that he was going to use it as a final project
for a class that James was teaching.  I suggested that he try a two
state HMM with autoregressive observation models, \ie, a model like
those described in section~\ref{sec:ARVGaussian} but with scalar
observations.

To use the expert classification information in training, Andreas and
I found that we need only modify the observation model.  The technique
is not limited to HMMs with only two states or two classes; it applies
to an arbitrary number of classes and to arbitrary numbers of states
associated with each class.  At each time $t$, let $\ti{c}{t}$ denote
classification information from an expert about which states are
possible.  Specifically $\ti{c}{t}$ is a vector that indicates that
some states are possible and that the others are impossible.  We
simply replace $P_{\ti{Y}{t}|\ti{S}{t},\ts{Y}{1}{t-1}}$ with
$P_{\ti{Y}{t},\ti{C}{t}|\ti{S}{t},\ts{Y}{1}{t-1}}$ wherever it occurs
in the Baum Welch algorithm.  Roughly, the modification forces the
system into states associated with the right class during training.

While the performance of Andreas' two state model was not memorable,
models with more states were promising.

\subsection{The Excellent Eye of Professor McNames}
\label{sec:mcnames}

To diagnose the errors, McNames printed spectrograms of every record.
As he reported in \cite{mcnames2000}, the first step in McNames
analysis was implementing his own QRS detection algorithm.  Then he
derived spectrograms from the resulting QRS analyses.  Although the
spectrograms discarded phase information that I hoped was important,
they clearly indicated the oscillations that I had tried to capture
with complicated HMMs as intense bands of power at frequencies below 2
cpm (cycles per minute).%
\nomenclature[rcpm]{cpm}{Cycles per minute.}%
In addition to those low frequency oscillations, he noticed bands of
power between 10 and 20 cpm in the spectrograms (See
Fig.~\ref{fig:sgram}).  That higher frequency power was evidence of
respiration.  Using both of those features, he classified the test
data by hand.  First he classified each entire record for \emph{event
  1}.  Since almost none of the minutes in the normal records are
apnea, he classified each minute in those records as normal.  His
third attempt at \emph{event 2} was the best entry at the close of the
contest.

\begin{figure}
  \centering{\resizebox{\textwidth}{!}{\includegraphics{sgram.pdf}}
  }
  \caption[Information about respiration in high
  frequency phase variations]% FixMe: Use the same parameters for this
                             % plot as used for the HMM
  {Information about respiration in high frequency phase variations.
    This is the $a11$ record roughly between minutes 00 and 150.  The
    upper plot is heart rate (bandpass filtered 0.09-3.66 cpm), the
    middle plot is a spectrogram of the phase jitter in the heart
    rate, and the lower plot is the expert classification.  A single
    band of spectral power between about 10 and 20 cpm without much
    power below the band in the spectrogram indicates normal
    respiration.}
  \label{fig:sgram}
\end{figure}

The question that motivated the contest is ``Is the information in an
ECG alone sufficient to classify apnea?'' McNames work answered the
question affirmatively.  For attempts to do the classification
automatically, his work suggests the following points:
\begin{enumerate}
\item Heart rate oscillations at about 1.3 cpm indicate apnea.
\item A clean phase jitter signal at about 14 cpm
  indicates normal respiration.
\end{enumerate}

\afterpage{\clearpage}%% Print this right here please.

\section{Using HMMs to Address the Challenge}
\label{sec:apnea_hmms}

In the following sections, as the final example in the book, I use
HMMs to address the CINC2000 challenge.  I begin with an HMM scheme
for estimating heart rate because, like McNames, I find off-the-shelf
QRS detection codes are not adequate for the variety of the CINC2000
data.  From the estimated heart rate signal for each record, I derive
a sequence of two dimensional observations.  The first component is
the low pass filtered heart rate, and the second is roughly the
intensity of the spectrogram in the range of respiration near 15
cycles per minute.  Next I fit an HMM with the vector autoregressive
observation models described in Section~\ref{sec:ARVGaussian} to the
training data.  And finally I apply that HMM to classify each minute
of the test data.

\subsection{Estimating Heart Rate}
\label{sec:ecg_hmms}

At first I tried using off-the-shelf code to extract heart rates from
the Physionet ECG data.  Figure~\ref{fig:elgendi} illustrates results
of using one of the detectors\footnote{Elgendi, Mohamed \& Jonkman,
  Mirjam \& De Boer, Friso. (2010). "Frequency Bands Effects on QRS
  Detection" The 3rd International Conference on Bio-inspired Systems
  and Signal Processing (BIOSIGNALS2010). 428-431.} implemented by
Porr et al.\footnote{https://github.com/berndporr/py-ecg-detectors},
and Figure~\ref{fig:a03a10b03c02} illustrates the challenging
diversity of waveforms in the Physionet data.  To address the
diversity of waveforms, I developed an approach to estimating heart
rates from ECGs based on HMMs that relies on the observation that for
each record the shape and duration of the $PQRST$ pattern doesn't
vary.  For different heart rates the time between the $T$ wave and the
next $P$ wave does change, but the rest of the pattern varies very
little.  Figure~\ref{fig:constant_a03} illustrates the invariance.

\begin{figure}
  \centering{\resizebox{0.8\textwidth}{!}{\includegraphics{elgendi.pdf}}
  }
  \caption[Inadequate off-the-shelf ECG detectors]%
  {In this segment of the ECG for record a03, stars indicate estimates
    of the R wave locations by an off-the-shelf detector\cite{porr},
    and $\times$s indicate estimates from the algorithm described in
    Section~\ref{sec:ecg_hmms}. }
  \label{fig:elgendi}
\end{figure}

\begin{figure}
  \centering{\resizebox{0.8\textwidth}{!}{\includegraphics{a03a10b03c02.pdf}}
  }
  \caption[Segments of ECGs from four records]%
  {Segments of ECGs from four records.  The ECGs for the different
    data records were so different from each other that off-the-shelf
    code was not adequate for estimating heart rate signals.}
  \label{fig:a03a10b03c02}
\end{figure}

\marginpar{FixMe: Label PQRST}
\begin{figure}
  \centering{\resizebox{\textwidth}{!}{\includegraphics{constant_a03.pdf}}}
  \caption[Invariant PQRST shape]%
  {At different heart rates the shape and duration of the PQRST
    pattern doesnâ€™t change. Only the delay between the sequences
    changes.  Notice that the lengths of the time intervals in the
    upper and lower plots are identical.}
  \label{fig:constant_a03}
\end{figure}

\begin{figure}
  \centering{\resizebox{0.5\textwidth}{!}{\input{ecg_hmm.pdf_t}}
  }
  \caption[Topology of HMMs for exploiting invariance of PQRST
  shapes]{Illustration of the topology of HMMs for exploiting
    invariance of PQRST shapes. The chain of 49 fast states models the
    invariant PQRST shape.  The variable duration paths through the
    slow states, $S_1$, $S_2$, and $S_3$, model the flexible time
    between $T$ and $P$ waves.}
  \label{fig:ecg_hmm}
\end{figure}

\begin{itemize}
\item Loop of 52 discrete states
\item A sequence of 49 \emph{fast} states that don't branch, state $n$ must
  transition to state $n+1$ at each time step
\item Three \emph{slow} states accommodate heart rate variations.
  Each of the three branches to one of the following:
  \begin{itemize}
  \item Itself
  \item Its successor
  \item The first fast state
  \end{itemize}
\end{itemize}
The minimum number of states visited in a loop is 50, or 500~ms since
the ECG data was sampled at 100~Hz.  Consequently the model is not
appropriate for heart rates above 120~bpm.

A special \emph{outlier} state accommodates ECG-lead noise.

I used a Gaussian scalar autoregressive observation model with means
for each state being an affine function of the previous three
observations and variances fit to each state separately.  The models
are one dimensional versions of those described in
Section~\ref{sec:ARVGaussian}.

I used scipy.signal.find\_peaks to supervise training of an initial
model for one of the records from CINC 2000.  I derived models for the
most\footnote{For a few of the records I used other techniques to
  obtain initial models.} other records from that initial model via
unsupervised training.

\begin{figure}
  \centering{\resizebox{0.8\textwidth}{!}{\includegraphics{a01c02_states.pdf}}
  }
  \caption[Decoded state sequences]{State sequences from Viterbi
    decoding of ECG signals for two records appear.  The invariant
    $PQRST$ pattern maps to the lines of constant slope.  The varying
    lengths of the horizontal segments accounts for variable time
    between heart beats.}
  \label{fig:a01c02_states}
\end{figure}

\begin{figure}
  \centering{\resizebox{\textwidth}{!}{0.8\includegraphics{simulated.pdf}}
  }
  \caption[Simulated ECG]{A plausible ECG appears in the upper plot,
    and the corresponding state sequence appears in the lower plot.
    Driving a model fit to data with a random number generator created
  both plots.}
  \label{fig:simulated}
\end{figure}

\subsubsection{Mapping state sequences to heart rate}
\label{sec:states2hr}

\begin{figure}
  \centering{\resizebox{0.8\textwidth}{!}{\includegraphics{ecg2hr.pdf}}
  }
  \caption[Heart rate derived from ECG.]{An illustration of using
    Viterbi decoding to derive heart rate from an ECG.  An ECG segment
    appears in the upper plot, and the corresponding segment of the
    decoded state sequence appears in the middle plot.  The $\times$
    marks in the middle plot indicate the times when the state is 31.
    The same times are also indicated in the upper plot.  The inverse
    of the difference in time between adjacent $x$s provides the
    estimated heart rate.  A smoothed version of those estimates
    sampled periodically at 2 Hz appears in the lower plot. }
  \label{fig:ecg2hr}
\end{figure}

\afterpage{\clearpage}%% Print this right here please.

\subsection{An Observation Model}
\label{sec:apnea_observation_model}

\subsection{Using a Sequence of Class Probabilities}
\label{sec:prettygood}

Equation \eqref{eq:wit} (2.20), ie,
\begin{equation*}
  w(s,t) \equiv P_{\ti{S}{t}|\ts{Y}{1}{T}} \left(s|\ts{y}{1}{T}
  \right),
\end{equation*}
gives the probability of each state at each time given the model and
all of the observations.  From such state weights, I construct the
sequence of ratios
\begin{equation*}
  \ti{r}{t} \equiv \frac{\sum_{s\in A} w(s,t)}{\sum_{s\in N} w(s,t)}
\end{equation*}
where $A$ is the set of apnea states and $N$ is the set of normal
states.  Finally I derive a sequence of classifications,
$\ts{c}{1}{T}$, from the sequence of ratios, $\ts{r}{1}{T}$, by
comparing to a threshold, $R$,
\begin{equation}
  \label{eq:class_sequence}
  \ti{c}{t} =
  \begin{cases}
    N & \ti{r}{t} < R \\
    A & \ti{r}{t} >= R
  \end{cases}.
\end{equation}

\section{Classification Versus Estimation}
\label{sec:ClassVsEst}

In the early chapters of this book, I have emphasized choosing model
parameters to maximize the likelihood of the data, the tweaks and
fudges I've used in this chapter are not concerned with improving
classification performance rather than improving likelihood.  While it
is true that if one had access to accurate probabilistic
characterizations of observations conditional on class membership the
best classifier would be a likelihood ratio classifier, it is not true
that without such characterizations the best approach to
classification is to estimate them.  This point is made forcefully by
Vapnik\cite{Vapnik98} who said, ``one should solve the [classification]
problem directly and never solve a more general problem as an
intermediate step.''

%%%
%%% Local Variables:
%%% TeX-master: "main"
%%% eval: (load-file "hmmkeys.el")
%%% End:
