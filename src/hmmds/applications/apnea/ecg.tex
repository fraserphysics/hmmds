% Notes on modeling ECGs with HMMs directly

\documentclass[12pt]{article}
\usepackage{graphicx,color}
\usepackage{amsmath, amsfonts}
\usepackage{placeins}

\newcommand{\field}[1]{\mathbb{#1}}
\newcommand{\INTEGER}{\field{Z}}
\newcommand{\REAL}{\field{R}}
\newcommand{\COMPLEX}{\field{C}}
\newcommand{\id}{\mathbb{I}}
\newcommand{\variance}[1]{\field{V}\left[ #1 \right]}
\newcommand{\normal}[2]{{\cal N}\left(#1,#2 \right)}
\newcommand{\argmax}{\operatorname*{argmax}}

\title{HMMs for ECGs}
\author{Andrew M.\ Fraser}

\begin{document}
\maketitle

\section{Introduction}
\label{sec:introduction}

I wrote explore.py to see how processing ECGs for apnea detection was
working.  Because I was disappointed by the performance of standard qrs
detectors that I got from
https://github.com/berndporr/py-ecg-detectors, I wrote my own by
building HMMs for ECG time series.

Recipes for making the models and figures described here appear in
Rules.mk.

\section{Outliers}
\label{sec:outliers}

While most of the ECG data consists of oscillations with amplitudes
less than $\pm$ 2mV, some intervals have spurious signals with $\pm$
10mV.  I call such signals \emph{lead noise}\footnote{The data in
  record \emph{C01} is less than .1mV till minute 5.1 when it goes to
  10 mV.  The usable data only starts at minute 10.24.}.  A model,
$\theta$, fit to the typical data can assign $P(y|\theta) = 0$ to lead
noise.  The observation models use inverse gamma priors for the
variance, and I use a single state, which I call the \emph{bad} state,
with prior that enforces a large variance to accommodate lead noise.
In particular the parameters are $\alpha=10^{8}$ and $\beta=10^{20}$
which in the reestimation formula
\begin{equation*}
  \sigma^2 = \frac{2 \beta + \text{data}}{2 \alpha +2 + \text{weight}}
\end{equation*}
gives $\sigma^2 \approx 10^{12}$ if there is not much data.  I arrived
at those values by trial and error.

Since lead noise can start abruptly at any time, I allow
transitions\footnote{As of 2023-03-22 I am not using bad states.}
between the bad state and every other state.  It's important to ensure
that those transitions are infrequent.  The high variance makes the
likelihood for the bad state small.

\section{A Model with a 49 State Chain}
\label{sec:mono20}

After trying many state topologies, I found that an HMM with a chain
of states that matches the ECG sequence PQRST with a fixed
duration\footnote{Each state in the chain has a single successor.}
works for record a01 if it is trained on that record.  Viterbi
decoding with the model after training for 50 iterations on record
\emph{a01} yields Figures~\ref{fig:dict_states_70} and
\ref{fig:dict_states_71}.  Note that the segments in the two figures
have the same duration, 0.04 minutes or 2.4 seconds, and that they are
separated by 10.5 seconds.  The doubling of the patient's heart rate
reflects an apnea cycle.  The HMM tracks the changing heart rate
without missing or inserting beats.

\begin{figure}
  \centering
    \resizebox{0.7\textwidth}{!}{\includegraphics{dict_3_2_states_70.pdf}}
    \caption{Performance of the HMM with a single chain of 49 states
      trained to model PRQST sequences.  An short segment of the ECG
      signal appears in the upper plot, while the corresponding
      decoded state sequence appears in the lower plot.  The model was
      fit using 50 iterations of the Baum Welch algorithm.}
  \label{fig:dict_states_70}
\end{figure}

\begin{figure}
  \centering
  \resizebox{0.7\textwidth}{!}{\includegraphics{dict_3_2_states_71.pdf}}
  \caption{Performance of the same model used for
    Fig.~\ref{fig:dict_states_70}, but looking at a different
    segment of the data.}
  \label{fig:dict_states_71}
\end{figure}

\subsection{Awkward Prior}
\label{sec:awkward}

I used inverse gamma priors with hyper-parameters $\alpha=10^3$ and
$\beta=10^2$ for observation models in generating
Figs.~\ref{fig:dict_states_70} and \ref{fig:dict_states_71}.  Those
values kept the variances of the observation models larger than they
would be otherwise.  Allowing smaller variances with $\alpha=10^2$ and
$\beta=1.0$ yields Figs.~\ref{fig:bad_dict_70} and
\ref{fig:bad_dict_71}.

\begin{figure}
  \centering
    \resizebox{0.7\textwidth}{!}{\includegraphics{dict_2_0_states_70.pdf}}
    \caption{Like Fig.~\ref{fig:dict_states_70}, but with less
      constraining prior.}
  \label{fig:bad_dict_70}
\end{figure}

\begin{figure}
  \centering
  \resizebox{0.7\textwidth}{!}{\includegraphics{dict_2_0_states_71.pdf}}
  \caption{Like Fig.~\ref{fig:dict_states_71}, but with less
    constraining prior.}
  \label{fig:bad_dict_71}
\end{figure}

\section{Quadratic Fit to Peak}
\label{sec:quadratic}

Here I find an estimate of the location of a peak based data sampled
periodically.  I fit a quadratic function to a local maximum and its
two neighbors.  WLOG the (x,y) sample pairs are $[(-d,a), (0,b),
(d,c)]$, and the quadratic function is
\begin{equation*}
  y(x) = \alpha x^2 + \beta x + \gamma.
\end{equation*}
Some manipulation yields:
\begin{align*}
  \alpha &= \frac{a+c-2b}{2d^2} \\
  \beta &= \frac{c-a}{2d} \\
  \gamma &= b \\
  \frac{d}{dx} y(x) &= 2x\alpha + \beta
\end{align*}
So the quadratic estimate of the peak location is
\begin{equation*}
  \argmax_x y(x) = \frac{-\beta}{2\alpha} = \frac{d(a-c)}{2(a+c-2b)}.
\end{equation*}

\section{To Do}
\label{sec:todo}

\begin{itemize}
\item See if parallel PQRST chains let me relax the prior of the
  observation model.
\item Plots to show data from \emph{a01} and \emph{c01}
\end{itemize}
\section{Times}
\label{sec:times}


\end{document}
